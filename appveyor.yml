version: '{build}'

skip_branch_with_pr: true

image: Visual Studio 2015

platform:
  - x64
  - x86

matrix:
  fast_finish: true
  allow_failures:
    - platform: x64
    - platform: x86

install:
  - ps: echo $PWD

build_script:
  - ps: .\build.ps1

after_build:
  - ps: |
      $n = Get-ChildItem -Path .\build\ -Filter *.nupkg | Select-Object -First 1
      If (!$n) { throw "Missing nupkg." }
      Push-AppveyorArtifact $n.FullName -DeploymentName Chocolatey

test_script:
  - ps: .\tests\install.ps1
  - ps: .\tests\run-meteor.ps1
  - ps: .\tests\uninstall.ps1
  # Make sure that it's no longer installed.
  - ps: If ((.\tests\run-meteor.ps1)) { throw }

deploy:
  - provider: Environment
    name: Chocolatey
    artifact: /^meteor.*\.nupkg/
    on:
      appveyor_repo_tag: true
      appveyor_repo_tag_name: /^release\/([0-9]+\.){2,3}[0-9]+(-(beta|rc)-[0-9]+)?$/
      platform: x64
